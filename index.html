<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Menú Quincenal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style id="app-style">
        /* 1) BODY LIGHT THEME */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff; 
            color: #333333;
            padding: 20px;
        }
        
        .card {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #888;
            background-color: #f0f0f0;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #bbb;
            margin-bottom: 15px;
        }
        
        .day-card {
            height: 100%;
            transition: transform 0.2s;
        }
        
        .day-card:hover {
            transform: translateY(-5px);
        }
        
        .meal-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .meal-section {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .lunch-section {
            background-color: #d0e7ff;   /* light blue */
        }
        
        .dinner-section {
            background-color: #d0ffd8;  /* light green */
        }
        
        .error-section {
            background-color: #5a1a1a;
            color: #f1f1f1;
        }
        
        .btn-generate {
            background-color: #5a9;
            border-color: #478;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-generate:hover {
            background-color: #478;
            border-color: #424;
        }
        
        .btn-start-over {
            background-color: #555;
            border-color: #444;
        }
        
        .btn-start-over:hover {
            background-color: #444;
            border-color: #393;
        }
        
        .spinner-grow {
            width: 1rem;
            height: 1rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 992px) {
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .day-header {
            font-weight: bold;
            background-color: #444;
            color: #f1f1f1;
            padding: 1.5rem 8px 8px;    /* ↑ extra top padding so the icon won't overlap */
            border-radius: 5px 5px 0 0;
            border-bottom: 2px solid #5a9;
        }
        
        .file-name {
            font-style: italic;
            color: #8fd19e;
            font-weight: 500;
        }
        
        .alert-danger {
            background-color: #a83c3c;
            color: #f1f1f1;
        }
        .alert-danger .btn-close {
            filter: invert(1);
        }
        
        .alert-error {
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .hidden {
            display: none;
        }
        
        /* New: expandable details panel */
        .recipe-details {
            max-height: 0;
            overflow: hidden;
            padding: 0 1rem;
            font-size: 0.85rem;
            color: #333;

            /* UPDATED: add opacity transition */
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        .recipe-details.open {
            /* sufficiently large to show contents */
            max-height: 500px;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;

            /* UPDATED: fade in */
            opacity: 1;
        }
        .recipe-details h5 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .recipe-details ul,
        .recipe-details ol {
            margin: 0 0 0.5rem 1rem;
            padding: 0;
        }
        
        /* Highlight label badge */
        .label-badge {
            background-color: #5a9;
            color: #fff;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        /* PDF Export Button */
        .btn-export-pdf {
            background-color: #dc3545;
            border-color: #c82333;
            color: white;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .btn-export-pdf:hover {
            background-color: #c82333;
            border-color: #bd2130;
            color: white;
        }

        .btn-export-pdf:disabled {
            background-color: #e99;
            border-color: #e77;
        }

        /* PDF Preview Container */
        #pdf-preview-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        /* PDF Export Status */
        .export-status {
            display: inline-block;
            margin-left: 10px;
            font-style: italic;
            color: #666;
        }

        /* PDF Style */
        @media print {
            .pdf-day {
                page-break-after: always;
                margin-bottom: 30px;
            }
            
            .pdf-day-header {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 15px;
                border-bottom: 2px solid #333;
                padding-bottom: 5px;
            }
            
            .pdf-meal-title {
                font-weight: bold;
                margin-top: 15px;
                margin-bottom: 10px;
                font-size: 16px;
            }
            
            .pdf-ingredients-title {
                font-weight: bold;
                margin-top: 10px;
                margin-bottom: 5px;
                font-size: 14px;
            }
            
            .pdf-steps-title {
                font-weight: bold;
                margin-top: 10px;
                margin-bottom: 5px;
                font-size: 14px;
            }
            
            .pdf-ingredients-list {
                margin-left: 20px;
                margin-bottom: 10px;
            }
            
            .pdf-steps-list {
                margin-left: 20px;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col">
                <h1 class="text-center mb-3">Generador de Menú Quincenal</h1>
                <p class="text-center text-muted">Carga un archivo JSON con tus recetas y genera un menú para dos semanas sin repetir ingredientes en el mismo día.</p>
            </div>
        </div>
        
        <div id="error-container" class="row mb-4 hidden">
            <div class="col">
                <div class="alert alert-danger alert-dismissible fade show alert-error" role="alert">
                    <strong>¡Error!</strong> <span id="error-message">¡Vaya! Algo salió mal cargando tu archivo. ¿Lo intentamos otra vez?</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div id="upload-section">
                            <div id="upload-area" class="upload-area mb-3">
                                <i class="bi bi-cloud-arrow-up upload-icon"></i>
                                <h4>Arrastra y suelta tu archivo JSON</h4>
                                <p class="text-muted">o haz clic para seleccionar archivo</p>
                                <input type="file" id="recipe-file" class="d-none" accept=".json">
                            </div>
                            <div id="file-info" class="text-center mb-3 hidden">
                                <p>Archivo cargado: <span id="file-name" class="file-name"></span></p>
                            </div>
                            <div class="d-flex justify-content-center mt-3">
                                <button id="generate-btn" class="btn btn-generate me-2" disabled>
                                    <span id="generate-btn-text">Generar Menú</span>
                                    <span id="loading-spinner" class="spinner-grow spinner-grow-sm ms-2 hidden" role="status" aria-hidden="true"></span>
                                </button>
                                <button id="start-over-btn" class="btn btn-start-over hidden">Comenzar de nuevo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Export to PDF Button -->
        <div id="export-pdf-container" class="row mb-4 hidden">
            <div class="col d-flex justify-content-end">
                <button id="export-pdf-btn" class="btn btn-export-pdf" disabled>
                    <i class="bi bi-file-earmark-pdf me-2"></i>Exportar a PDF
                    <span id="export-spinner" class="spinner-grow spinner-grow-sm ms-2 hidden" role="status" aria-hidden="true"></span>
                </button>
                <span id="export-status" class="export-status"></span>
            </div>
        </div>
        
        <div id="menu-container" class="row mb-4 hidden">
            <div class="col">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Menú para 14 días</h3>
                    </div>
                    <div class="card-body">
                        <div id="calendar-grid" class="calendar-grid">
                            <!-- Days will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PDF Preview Container (Hidden) -->
        <div id="pdf-preview-container" class="hidden">
            <div id="pdf-content">
                <!-- PDF content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Edit Day Modal -->
    <div class="modal fade" id="editDayModal" tabindex="-1" aria-labelledby="editDayModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editDayModalLabel">Editar Día</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <form id="edit-day-form">
              <div class="mb-3">
                <label for="edit-comida-select" class="form-label">Comida</label>
                <select id="edit-comida-select" class="form-select"></select>
              </div>
              <div class="mb-3">
                <label for="edit-cena-select" class="form-label">Cena</label>
                <select id="edit-cena-select" class="form-select"></select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="save-edit-btn" class="btn btn-primary">Guardar cambios</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recipe Details Modal -->
    <div class="modal fade" id="recipeModal" tabindex="-1" aria-labelledby="recipeModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="recipeModalLabel">Receta</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script id="app-script">
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('recipe-file');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const generateBtn = document.getElementById('generate-btn');
            const generateBtnText = document.getElementById('generate-btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const startOverBtn = document.getElementById('start-over-btn');
            const menuContainer = document.getElementById('menu-container');
            const calendarGrid = document.getElementById('calendar-grid');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const recipeModalEl = document.getElementById('recipeModal');
            const recipeModal = new bootstrap.Modal(recipeModalEl);
            const recipeModalLabel = recipeModalEl.querySelector('.modal-title');
            const recipeModalBody  = recipeModalEl.querySelector('.modal-body');
            const exportPdfContainer = document.getElementById('export-pdf-container');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportSpinner = document.getElementById('export-spinner');
            const exportStatus = document.getElementById('export-status');
            const pdfPreviewContainer = document.getElementById('pdf-preview-container');
            const pdfContent = document.getElementById('pdf-content');
            
            // State
            let recipes = null;
            let menuData = null;
            let pdfBlob = null;
            let pdfFilename = 'menu-quincenal.pdf';
            
            // Check LocalStorage for cached recipes
            const cachedRecipes = localStorage.getItem('cachedRecipes');
            if (cachedRecipes) {
                try {
                    recipes = JSON.parse(cachedRecipes);
                    fileName.textContent = 'Recetas cargadas desde caché';
                    fileInfo.classList.remove('hidden');
                    generateBtn.disabled = false;
                } catch (e) {
                    localStorage.removeItem('cachedRecipes');
                }
            }
            
            // Event Listeners
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#5a9';
                uploadArea.style.backgroundColor = '#3d3d3d';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#dee2e6';
                uploadArea.style.backgroundColor = '#fff';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#dee2e6';
                uploadArea.style.backgroundColor = '#fff';
                
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    handleFile(fileInput.files[0]);
                }
            });
            
            generateBtn.addEventListener('click', generateMenu);
            
            startOverBtn.addEventListener('click', () => {
                // Reset UI state
                menuContainer.classList.add('hidden');
                startOverBtn.classList.add('hidden');
                errorContainer.classList.add('hidden');
                fileInfo.classList.add('hidden');
                exportPdfContainer.classList.add('hidden');
                pdfPreviewContainer.classList.add('hidden');
                generateBtn.disabled = true;
                fileInput.value = '';
                recipes = null;
                menuData = null;
                pdfBlob = null;
                exportPdfBtn.disabled = true;
                exportStatus.textContent = '';
            });
            
            exportPdfBtn.addEventListener('click', exportToPdf);
            
            // Functions
            function handleFile(file) {
                if (!file.type.includes('json')) {
                    showError('El archivo debe ser de tipo JSON');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // New validation: object must have both comidas and cenas arrays
                        if (
                          !data ||
                          !Array.isArray(data.comidas) ||
                          !Array.isArray(data.cenas)
                        ) {
                            showError("El archivo JSON debe tener las claves 'comidas' y 'cenas'.");
                            return;
                        }
                        
                        // (Optional) lighter validation per recipe—just check it has at least a title
                        const validComidas = data.comidas.every(r => r.titulo);
                        const validCenas  = data.cenas .every(r => r.titulo);
                        if (!validComidas || !validCenas) {
                            showError("Cada receta debe tener al menos un 'titulo'.");
                            return;
                        }
                        
                        // Assign validated structure
                        recipes = {
                          comidas: data.comidas,
                          cenas:  data.cenas
                        };
                        
                        // Cache valid recipes
                        localStorage.setItem('cachedRecipes', JSON.stringify(recipes));
                        
                        // Update UI
                        fileName.textContent = file.name;
                        fileInfo.classList.remove('hidden');
                        generateBtn.disabled = false;
                        errorContainer.classList.add('hidden');
                        
                    } catch (e) {
                        showError('El archivo JSON no es válido');
                    }
                };
                
                reader.readAsText(file);
            }
            
            function showError(message) {
                // If a generic error, use our friendly tone
                errorMessage.textContent = message.includes('intentos')
                    ? message
                    : '¡Vaya! Algo salió mal cargando tu archivo. ¿Lo intentamos otra vez?';
                errorContainer.classList.remove('hidden');
                recipes = null;
                generateBtn.disabled = true;
            }
            
            function generateMenu() {
                // Show loading state
                generateBtn.disabled = true;
                loadingSpinner.classList.remove('hidden');
                generateBtnText.textContent = 'Generando...';
                
                // Clear previous menu
                calendarGrid.innerHTML = '';
                
                // Simulate menu generation (would be replaced with actual algorithm)
                setTimeout(() => {
                    menuData = generateMenuData(recipes);
                    renderMenu(menuData);
                    
                    // Show menu and reset UI
                    menuContainer.classList.remove('hidden');
                    startOverBtn.classList.remove('hidden');
                    exportPdfContainer.classList.remove('hidden');
                    generateBtn.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    generateBtnText.textContent = 'Generar Menú';
                    
                    // Auto-trigger PDF export
                    //exportToPdf();
                    
                    // Show error alert if any days failed to generate
                    const hasErrors = menuData.some(day => day.error);
                    if (hasErrors) {
                        errorMessage.textContent = 'No se pudo generar el menú completo. Hay días con errores.';
                        errorContainer.classList.remove('hidden');
                    } else {
                        errorContainer.classList.add('hidden');
                    }
                }, 1500);
            }
            
            function generateMenuData(recipes) {
                const days = [];
                const weekdays = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
                
                for (let i = 0; i < 14; i++) {
                    const dayNumber    = i + 1;
                    const weekNumber   = Math.floor(i / 7) + 1;
                    const weekdayIndex = i % 7;
                    let attempt = 0;
                    let found   = false;
                    
                    while (attempt < 50 && !found) {
                        attempt++;
                        // select candidates
                        const lunchIdx  = Math.floor(Math.random() * recipes.comidas.length);
                        const dinnerIdx = Math.floor(Math.random() * recipes.cenas.length);
                        const lunch  = recipes.comidas[lunchIdx];
                        const dinner = recipes.cenas [dinnerIdx];
                        
                        // a) no shared ingredients
                        const lunchIngsNames  = new Set(lunch.ingredientes.map(x => x.ingrediente));
                        const dinnerIngsNames = new Set(dinner.ingredientes.map(x => x.ingrediente));
                        const shared = [...lunchIngsNames].some(ing => dinnerIngsNames.has(ing));
                        if (shared) continue;
                        
                        // b) not used in same slot last two days
                        const prevLunches = days.slice(-2).map(d => d.lunch).filter(Boolean);
                        const prevDinners = days.slice(-2).map(d => d.dinner).filter(Boolean);
                        if (prevLunches.includes(lunch.titulo) || prevDinners.includes(dinner.titulo)) {
                            continue;
                        }
                        if((lunch.tiene_carne && dinner.tiene_carne)|| (lunch.tiene_pescado && dinner.tiene_pescado)){
                            continue;
                        }
                        console.log("Combi")
                        console.log(lunch)
                        console.log(dinner)
                        console.log("------")
                        // if ok, push and mark found
                        days.push({
                            day:     dayNumber,
                            weekday: weekdays[weekdayIndex],
                            week:    weekNumber,
                            lunch:   lunch.titulo,
                            lunchObj: lunch,
                            dinner:  dinner.titulo,
                            dinnerObj: dinner
                        });
                        found = true;
                    }
                    
                    if (!found) {
                        // assign error for this day
                        days.push({
                            day:     dayNumber,
                            weekday: weekdays[weekdayIndex],
                            week:    weekNumber,
                            error:   'No se pudo generar una combinación válida para este día.'
                        });
                    }
                }
                
                return days;
            }
            
            function renderMenu(menuData) {
                menuData.forEach((day, dayIndex) => {
                    const dayCard = document.createElement('div');
                    dayCard.className = 'day-card card h-100 position-relative'; // make room for edit icon
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = `${day.weekday} (Día ${day.day})`;
                    
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    
                    if (day.error) {
                        const errorSection = document.createElement('div');
                        errorSection.className = 'error-section meal-section';
                        errorSection.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${day.error}`;
                        cardBody.appendChild(errorSection);
                    } else {
                        ['lunch','dinner'].forEach(mealType => {
                            const section = document.createElement('div');
                            section.className = (mealType==='lunch' ? 'lunch-section' : 'dinner-section') + ' meal-section';
                            
                            // Title
                            const recipeTitle = document.createElement('p');
                            recipeTitle.className = 'meal-title clickable';
                            recipeTitle.innerHTML = `
                            <i class="bi ${mealType==='lunch'?'bi-sun':'bi-moon'} me-2"></i>
                            <span class="label-badge">${mealType === 'lunch' ? 'Comida' : 'Cena'}</span><br/>
                            <span>${day[mealType]}</span>
                            `;
                            
                            // Open details in modal
                            recipeTitle.addEventListener('click', () => {
                                const source = mealType === 'lunch' ? recipes.comidas : recipes.cenas;
                                const recipe = source.find(r => r.titulo === day[mealType]);
                                if (!recipe) return;
                                recipeModalLabel.textContent = recipe.titulo;
                                recipeModalBody.innerHTML = `
                                <h5>Ingredientes</h5>
                                <ul>
                                    ${recipe.ingredientes.map(i => `<li>${i.ingrediente} – ${i.cantidad}</li>`).join('')}
                                </ul>
                                <h5>Pasos</h5>
                                <ol>
                                    ${recipe.pasos.map(p => `<li>${p}</li>`).join('')}
                                </ol>
                                `;
                                recipeModal.show();
                            });
                            
                            section.appendChild(recipeTitle);
                            // no inline detailPanel anymore
                            cardBody.appendChild(section);
                        });
                    }
                    
                    // Add edit button (pencil icon) to top-right
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-light btn-pencil';
                    editBtn.style.top = '8px';    /* move it just below the extra header padding */
                    editBtn.style.right = '8px';
                    editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                    editBtn.addEventListener('click', () => openEditModal(dayIndex));
                    dayCard.appendChild(editBtn);
                    
                    dayCard.appendChild(dayHeader);
                    dayCard.appendChild(cardBody);
                    calendarGrid.appendChild(dayCard);
                });
            }
            
            // Export to PDF functionality
            function exportToPdf() {
                if (!menuData) return;
                
                // Show loading state
                exportPdfBtn.disabled = true;
                exportSpinner.classList.remove('hidden');
                exportStatus.textContent = 'Generando PDF...';
                
                // Generate PDF content
                generatePdfContent();
                
                // Simulate API call for PDF generation
                setTimeout(() => {
                    // Would be replaced with actual API call
                    generatePdfFile();
                    
                    // Re-enable button and show download link
                    exportPdfBtn.disabled = false;
                    exportSpinner.classList.add('hidden');
                    exportStatus.textContent = 'PDF generado con éxito';
                }, 2000);
            }
            
            function generatePdfContent() {
                // Clear previous content
                pdfContent.innerHTML = '';
                
                // Create PDF content structure
                menuData.forEach(day => {
                    if (day.error) return; // Skip days with errors
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'pdf-day';
                    
                    // Day header
                    const dayHeader = document.createElement('h2');
                    dayHeader.className = 'pdf-day-header';
                    dayHeader.textContent = `${day.weekday} (Día ${day.day})`;
                    dayElement.appendChild(dayHeader);
                    
                    // Lunch section
                    const lunchTitle = document.createElement('h3');
                    lunchTitle.className = 'pdf-meal-title';
                    lunchTitle.textContent = 'Comida: ' + day.lunch;
                    dayElement.appendChild(lunchTitle);
                    
                    // Lunch ingredients
                    const lunchIngredientsTitle = document.createElement('h4');
                    lunchIngredientsTitle.className = 'pdf-ingredients-title';
                    lunchIngredientsTitle.textContent = 'Ingredientes:';
                    dayElement.appendChild(lunchIngredientsTitle);
                    
                    const lunchIngredientsList = document.createElement('ul');
                    lunchIngredientsList.className = 'pdf-ingredients-list';
                    day.lunchObj.ingredientes.forEach(ing => {
                        const item = document.createElement('li');
                        item.textContent = `${ing.ingrediente} - ${ing.cantidad}`;
                        lunchIngredientsList.appendChild(item);
                    });
                    dayElement.appendChild(lunchIngredientsList);
                    
                    // Lunch steps
                    const lunchStepsTitle = document.createElement('h4');
                    lunchStepsTitle.className = 'pdf-steps-title';
                    lunchStepsTitle.textContent = 'Preparación:';
                    dayElement.appendChild(lunchStepsTitle);
                    
                    const lunchStepsList = document.createElement('ol');
                    lunchStepsList.className = 'pdf-steps-list';
                    day.lunchObj.pasos.forEach(step => {
                        const item = document.createElement('li');
                        item.textContent = step;
                        lunchStepsList.appendChild(item);
                    });
                    dayElement.appendChild(lunchStepsList);
                    
                    // Dinner section
                    const dinnerTitle = document.createElement('h3');
                    dinnerTitle.className = 'pdf-meal-title';
                    dinnerTitle.textContent = 'Cena: ' + day.dinner;
                    dayElement.appendChild(dinnerTitle);
                    
                    // Dinner ingredients
                    const dinnerIngredientsTitle = document.createElement('h4');
                    dinnerIngredientsTitle.className = 'pdf-ingredients-title';
                    dinnerIngredientsTitle.textContent = 'Ingredientes:';
                    dayElement.appendChild(dinnerIngredientsTitle);
                    
                    const dinnerIngredientsList = document.createElement('ul');
                    dinnerIngredientsList.className = 'pdf-ingredients-list';
                    day.dinnerObj.ingredientes.forEach(ing => {
                        const item = document.createElement('li');
                        item.textContent = `${ing.ingrediente} - ${ing.cantidad}`;
                        dinnerIngredientsList.appendChild(item);
                    });
                    dayElement.appendChild(dinnerIngredientsList);
                    
                    // Dinner steps
                    const dinnerStepsTitle = document.createElement('h4');
                    dinnerStepsTitle.className = 'pdf-steps-title';
                    dinnerStepsTitle.textContent = 'Preparación:';
                    dayElement.appendChild(dinnerStepsTitle);
                    
                    const dinnerStepsList = document.createElement('ol');
                    dinnerStepsList.className = 'pdf-steps-list';
                    day.dinnerObj.pasos.forEach(step => {
                        const item = document.createElement('li');
                        item.textContent = step;
                        dinnerStepsList.appendChild(item);
                    });
                    dayElement.appendChild(dinnerStepsList);
                    
                    pdfContent.appendChild(dayElement);
                });
            }
            
            function generatePdfFile() {
                // This would be replaced with an actual API call in production
                // For now, we'll just create a PDF file using jsPDF
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Pagination setup: 2 days per page
                const daysPerPage = 2;
                let dayCount = 0;
                let posY = 10;      // vertical cursor on current page
                
                // Add title
                doc.setFontSize(18);
                doc.text('Menú Quincenal', 105, posY, { align: 'center' });
                posY += 10;
                
                // Loop through validated days
                menuData.forEach((day) => {
                    if (day.error) return; // skip error days
                    
                    // If we've already placed 2 days on this page, start a new one
                    if (dayCount > 0 && dayCount % daysPerPage === 0) {
                        doc.addPage();
                        posY = 10;
                    }
                    
                    dayCount++;
                    
                    // Day header
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${day.weekday} (Día ${day.day})`, 10, posY);
                    posY += 8;
                    
                    // Lunch section
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Comida: ${day.lunch}`, 10, posY);
                    posY += 7;
                    
                    // ---- INGREDIENTS (bold) ----
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Ingredientes:`, 15, posY);
                    posY += 5;
                    
                    // List ingredients
                    doc.setFont(undefined, 'normal');
                    day.lunchObj.ingredientes.forEach(ing => {
                        doc.text(`• ${ing.ingrediente} - ${ing.cantidad}`, 20, posY);
                        posY += 5;
                    });
                    
                    // ---- PREPARACIÓN ----
                    doc.setFont(undefined, 'bold');
                    doc.text(`Preparación:`, 15, posY);
                    posY += 5;
                    doc.setFont(undefined, 'normal');
                    day.lunchObj.pasos.forEach(step => {
                        doc.text(`- ${step}`, 20, posY);
                        posY += 5;
                    });
                    
                    // Dinner section
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Cena: ${day.dinner}`, 10, posY);
                    posY += 7;
                    
                    // ---- INGREDIENTS ----
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Ingredientes:`, 15, posY);
                    posY += 5;
                    
                    doc.setFont(undefined, 'normal');
                    day.dinnerObj.ingredientes.forEach(ing => {
                        doc.text(`• ${ing.ingrediente} - ${ing.cantidad}`, 20, posY);
                        posY += 5;
                    });
                    
                    // ---- PREPARACIÓN ----
                    doc.setFont(undefined, 'bold');
                    doc.text(`Preparación:`, 15, posY);
                    posY += 5;
                    doc.setFont(undefined, 'normal');
                    day.dinnerObj.pasos.forEach(step => {
                        doc.text(`- ${step}`, 20, posY);
                        posY += 5;
                    });
                    
                    // extra spacing to separate days
                    posY += 10;
                });
                
                // Save PDF as blob
                pdfBlob = doc.output('blob');
                
                // Create download link
                const pdfUrl = URL.createObjectURL(pdfBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = pdfUrl;
                downloadLink.download = pdfFilename;
                downloadLink.className = 'btn btn-sm btn-success mt-2';
                downloadLink.innerHTML = '<i class="bi bi-download me-2"></i>Descargar PDF';
                
                // Add download link to export status
                exportStatus.innerHTML = 'PDF generado con éxito! ';
                exportStatus.appendChild(downloadLink);
                
                // Auto download
                downloadLink.click();
            }
            
            // State: track current day being edited
            let currentEditIndex = null;
            const editDayModalEl = document.getElementById('editDayModal');
            const editDayModal = new bootstrap.Modal(editDayModalEl);
            const comidaSelect = document.getElementById('edit-comida-select');
            const cenaSelect   = document.getElementById('edit-cena-select');
            const saveEditBtn  = document.getElementById('save-edit-btn');
            
            function openEditModal(dayIndex) {
                currentEditIndex = dayIndex;
                // Populate dropdowns with all recipes
                comidaSelect.innerHTML = recipes.comidas
                    .map(r => `<option value="${r.titulo}">${r.titulo}</option>`).join('');
                cenaSelect.innerHTML = recipes.cenas
                    .map(r => `<option value="${r.titulo}">${r.titulo}</option>`).join('');
                // Pre-select current values
                const dayCardData = calendarGrid.children[dayIndex];
                // extract titles from DOM (or store menuData globally if preferred)
                const currentTitleElems = dayCardData.querySelectorAll('.label-badge + br + span');
                if (currentTitleElems.length === 2) {
                    comidaSelect.value = currentTitleElems[0].textContent;
                    cenaSelect.value   = currentTitleElems[1].textContent;
                }
                editDayModal.show();
            }
            
            saveEditBtn.addEventListener('click', () => {
                const newComida = comidaSelect.value;
                const newCena   = cenaSelect.value;
                if (currentEditIndex == null) return;
                
                // Update the DOM for that day cell
                const dayCardData = calendarGrid.children[currentEditIndex];
                const mealSections = dayCardData.querySelectorAll('.meal-section');
                // lunch section
                mealSections[0].querySelector('span:last-child').textContent = newComida;
                // dinner section
                mealSections[1].querySelector('span:last-child').textContent = newCena;
                
                // Update menuData for PDF export
                if (menuData && menuData[currentEditIndex]) {
                    const comidaObj = recipes.comidas.find(r => r.titulo === newComida);
                    const cenaObj = recipes.cenas.find(r => r.titulo === newCena);
                    
                    if (comidaObj) {
                        menuData[currentEditIndex].lunch = newComida;
                        menuData[currentEditIndex].lunchObj = comidaObj;
                    }
                    
                    if (cenaObj) {
                        menuData[currentEditIndex].dinner = newCena;
                        menuData[currentEditIndex].dinnerObj = cenaObj;
                    }
                }
                
                editDayModal.hide();
                
                // Re-bind click handlers so modal shows updated details
                ['comida','cena'].forEach((type, idx) => {
                    const mealType = type === 'comida' ? 'lunch' : 'dinner';
                    const clickable = mealSections[idx].querySelector('.meal-title.clickable');
                    // remove any old listener by cloning
                    const clone = clickable.cloneNode(true);
                    clickable.parentNode.replaceChild(clone, clickable);
                    // attach fresh listener
                    clone.addEventListener('click', () => {
                        const source = mealType==='lunch' ? recipes.comidas : recipes.cenas;
                        const title   = clone.querySelector('span:last-child').textContent;
                        const recipe  = source.find(r => r.titulo === title);
                        if (!recipe) return;
                        recipeModalLabel.textContent = recipe.titulo;
                        recipeModalBody.innerHTML = `
                        <h5>Ingredientes</h5>
                        <ul>${recipe.ingredientes.map(i => `<li>${i.ingrediente} – ${i.cantidad}</li>`).join('')}</ul>
                        <h5>Pasos</h5>
                        <ol>${recipe.pasos.map(p => `<li>${p}</li>`).join('')}</ol>
                        `;
                        recipeModal.show();
                    });
                });
                
                // Reset PDF export button to generate a new PDF
                exportPdfBtn.disabled = false;
                exportStatus.textContent = 'Menú actualizado. Haz clic para generar un nuevo PDF.';
            });
        });
    </script>
</body>
</html>